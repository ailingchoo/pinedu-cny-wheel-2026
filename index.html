// =====================
// PIN EDU æ–°å¹´å¹¸è¿è½¬è½®ç›˜ï¼ˆåªé™ä¸€æ¬¡ï¼‰
// å¥–é¡¹ï¼šRM8 / RM18 / RM28 / RM58 / RM88ï¼ˆå¾ˆéš¾ä¸­ï¼‰
// =====================

// 1) å¥–é¡¹
const prizes = ["RM8", "RM18", "RM28", "RM58", "RM88 ğŸ†å¤§å¥–"];

// 2) ä¸­å¥–æƒé‡ï¼ˆæ€»å’Œ=100ï¼ŒRM88=2% å¾ˆéš¾ä¸­ï¼‰
const weights = [45, 30, 15, 8, 2];

// 3) ä¸€æ¬¡æ€§é™åˆ¶ï¼ˆåŒè®¾å¤‡åŒæµè§ˆå™¨åªå¯ä¸€æ¬¡ï¼‰
const STORAGE_KEY = "PINEDU_CNY_WHEEL_SPUN_V2";
const WIN_KEY = "PINEDU_CNY_WHEEL_WIN_V2";

// DOM
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const spinBtn = document.getElementById("spinBtn");
const resultText = document.getElementById("resultText");

const W = canvas.width, H = canvas.height;
const cx = W / 2, cy = H / 2;
const radius = Math.min(W, H) / 2 - 10;

let rotation = 0;    // å½“å‰è§’åº¦ï¼ˆå¼§åº¦ï¼‰
let spinning = false;

// é¢œè‰²ï¼šæ¯ä¸ªå¥–é¡¹ç¨³å®šåˆ†é…ä¸€ç§é¢œè‰²ï¼ˆä¸ç”¨æ‰‹æŒ‘ï¼‰
function hashToColor(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
  const r = 120 + (h % 90);
  const g = 120 + ((h >> 8) % 90);
  const b = 120 + ((h >> 16) % 90);
  return `rgb(${r},${g},${b})`;
}

// ç”»è½¬ç›˜
function drawWheel() {
  ctx.clearRect(0, 0, W, H);

  const n = prizes.length;
  const arc = (Math.PI * 2) / n;

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rotation);

  for (let i = 0; i < n; i++) {
    const start = i * arc;
    const end = start + arc;

    // æ‰‡å½¢
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, radius, start, end);
    ctx.closePath();
    ctx.fillStyle = hashToColor(prizes[i]);
    ctx.fill();

    // åˆ†å‰²çº¿
    ctx.strokeStyle = "rgba(255,255,255,.75)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // æ–‡æœ¬
    ctx.save();
    ctx.rotate(start + arc / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "rgba(17,24,39,.95)";
    ctx.font = "900 19px system-ui, sans-serif";
    ctx.fillText(prizes[i], radius - 16, 7);
    ctx.restore();
  }

  // ä¸­å¿ƒåœ†
  ctx.beginPath();
  ctx.arc(0, 0, 58, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(17,24,39,.92)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.35)";
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.font = "900 14px system-ui, sans-serif";
  ctx.fillText("PIN EDU", 0, -4);
  ctx.font = "700 12px system-ui, sans-serif";
  ctx.fillText("åªé™ä¸€æ¬¡æŠ½å¥–", 0, 16);

  ctx.restore();
}

// æƒé‡æŠ½å¥–
function pickIndexByWeight(ws) {
  const total = ws.reduce((a, b) => a + b, 0);
  let r = Math.random() * total;
  for (let i = 0; i < ws.length; i++) {
    r -= ws[i];
    if (r <= 0) return i;
  }
  return ws.length - 1;
}

// è®¡ç®—è½¬åˆ°æŒ‡å®šæ‰‡å½¢ï¼ˆæŒ‡é’ˆåœ¨ 12 ç‚¹æ–¹å‘ï¼‰
function angleToIndex(index) {
  const n = prizes.length;
  const arc = (Math.PI * 2) / n;
  const centerAngle = index * arc + arc / 2;
  const pointerAngle = -Math.PI / 2;
  let targetRotation = pointerAngle - centerAngle;
  targetRotation = ((targetRotation % (Math.PI * 2)) + (Math.PI * 2)) % (Math.PI * 2);
  return targetRotation;
}

// é”å®šï¼šè½¬è¿‡å°±ä¸èƒ½å†è½¬
function lockUIWithPrize(prize) {
  spinBtn.disabled = true;
  resultText.textContent = `âœ… ä½ å·²å®Œæˆä¸€æ¬¡æŠ½å¥–ï¼šğŸ‰ ${prize}`;
}

// è½¬åŠ¨åŠ¨ç”»
function spin() {
  if (spinning) return;

  // å·²è½¬è¿‡ç›´æ¥é”
  if (localStorage.getItem(STORAGE_KEY) === "1") {
    const savedPrize = localStorage.getItem(WIN_KEY) || "ï¼ˆå·²æŠ½å¥–ï¼‰";
    lockUIWithPrize(savedPrize);
    return;
  }

  spinning = true;
  spinBtn.disabled = true;
  resultText.textContent = "è½¬ç›˜æ—‹è½¬ä¸­â€¦ ğŸ¡";

  const winnerIndex = pickIndexByWeight(weights);
  const target = angleToIndex(winnerIndex);

  const extraSpins = 7 + Math.floor(Math.random() * 2); // 7~8åœˆæ›´æœ‰æ„Ÿè§‰
  const finalRotation = target + extraSpins * Math.PI * 2;

  const startRotation = rotation;
  const delta = finalRotation - startRotation;

  const duration = 4200;
  const start = performance.now();

  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function animate(now) {
    const t = Math.min(1, (now - start) / duration);
    rotation = startRotation + delta * easeOutCubic(t);
    drawWheel();

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      spinning = false;

      // å½’ä¸€åŒ–
      rotation = ((rotation % (Math.PI * 2)) + (Math.PI * 2)) % (Math.PI * 2);
      drawWheel();

      const prize = prizes[winnerIndex];

      // å†™å…¥æœ¬åœ°å­˜å‚¨ï¼šé”ä½åªèƒ½ä¸€æ¬¡
      localStorage.setItem(STORAGE_KEY, "1");
      localStorage.setItem(WIN_KEY, prize);

      lockUIWithPrize(prize);
    }
  }

  requestAnimationFrame(animate);
}

// åˆå§‹åŒ–ï¼šå¦‚æœå·²è½¬è¿‡ï¼Œé¡µé¢æ‰“å¼€å°±é”
function initOnceOnly() {
  drawWheel();

  if (localStorage.getItem(STORAGE_KEY) === "1") {
    const savedPrize = localStorage.getItem(WIN_KEY) || "ï¼ˆå·²æŠ½å¥–ï¼‰";
    lockUIWithPrize(savedPrize);
  }
}

spinBtn.addEventListener("click", spin);
initOnceOnly();
